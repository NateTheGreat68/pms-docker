#!/usr/bin/with-contenv bash
#
# Used by other scripts to decide of persistent config sync should be performed.
# Determines whether the directory specified by $HOME_PERSISTENT is mounted on a different filesystem than root.
# Returns 0 if it is on a different filesystem, and non-0 if the same filesystem.
# Can be forced with $FORCE_PERSISTENT or $FORCE_NO_PERSISTENT.

# If variable FORCE_PERSISTENT is set and not empty, it overrides all; otherwise, FORCE_NO_PERSISTENT can override all.
if [ ! -z ${FORCE_PERSISTENT+x} ]; then
  exit 0
elif [ ! -z ${FORCE_NO_PERSISTENT+x} ]; then
  exit 1
else
  # Compare some info from df to see if the /config_persistent exists and is mounted on the same filesystem as root.
  root_info=$(df | awk -v path="/" '{ if ( $6 == path ) print $2 ";" $3 ";" $4 }')
  home_persistent_info=$(df | awk -v path="$HOME_PERSISTENT" '{ if ( $6 == path ) print $2 ";" $3 ";" $4 }')
  [ ! -z ${home_persistent_info+x} ] && [ "$root_info" != "$home_persistent_info" ]
  exit $?
fi
