#!/usr/bin/with-contenv bash
#
# Copies the current config files from $HOME to $HOME_PERSISTENT, in a subdirectory.
# The subdirectory name is a UUID; no previously-good data is overwritten so that an interrupted transfer doesn't result in data loss.
# Only after the transfer is complete is will the new subdirectory be marked as the latest clean data, and the previous one marked for deletion.

echo "Syncing local config data to persistent storage."

last_uuid="$(cat "$HOME_PERSISTENT/.last_clean")"
new_uuid="$(uuidgen)"
echo "$new_uuid" > "$HOME_PERSISTENT/.purge_${new_uuid}" && \
    rsync -a "$HOME/" "$HOME_PERSISTENT/$new_uuid" && \
    rm -f "$HOME_PERSISTENT/.purge_${new_uuid}" && \
    echo "$new_uuid" > "$HOME_PERSISTENT/.last_clean" && \
    echo "$last_uuid" > "$HOME_PERSISTENT/.purge_${last_uuid}"

echo "Sync complete; new persistent config data directory is ${new_uuid}."
