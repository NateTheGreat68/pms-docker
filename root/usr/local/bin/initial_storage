#!/usr/bin/with-contenv bash
#
# Takes an existing data directory at $HOME_PERSISTENT and prepares it to be a maintained, clean, and safe persistent directory.
# First moves everything in the directory into a ".incomplete" subdirectory,
# then creates a UUID and renames ".incomplete" subdirectory to that UUID,
# then finally writes the UUID to a ".last_clean" file to signify the operation is complete.
# If interrupted before the transfer is complete, it can be resumed cleanly.

echo "Initializing persistent config data directory."

new_uuid="$(uuidgen)"
shopt -s extglob dotglob nullglob
mkdir -p "$HOME_PERSISTENT/.incomplete" && \
    for f in "$HOME_PERSISTENT/"!(.incomplete|.|..); do mv -f "$f" "$HOME_PERSISTENT/.incomplete/"; done && \
    mv -f "$HOME_PERSISTENT/.incomplete" "$HOME_PERSISTENT/$new_uuid"
    echo "$new_uuid" > "$HOME_PERSISTENT/.last_clean"
shopt -u extglob dotglob nullglob

echo "Initialization complete; persistent config data directory is ${new_uuid}."
